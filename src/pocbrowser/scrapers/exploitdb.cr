require "http/client"
require "json"

module Pocbrowser
  class ExploitDBScraper
    def parse(cve : String)
      endpoint = "https://www.exploit-db.com/search?cve=#{cve}"
      results = [] of String

      HTTP::Client.get(endpoint, HTTP::Headers{"x-requested-with" => "XMLHttpRequest"}) do |r|
        # Return [] if status code != 200
        if r.status_code != 200
          yield results
          return
        end

        # Should return JSON object
        # https://docs.github.com/en/rest/search#search-repositories
        search_results = JSON.parse(r.body_io)

        begin
          # Return [] if "total_count" = 0 or it is not an int
          if search_results["data"].as_a.size == 0
            yield results
            return
          end

          search_results["data"].as_a.each do |item|
            id = item["id"].as_s
            results << "https://www.exploit-db.com/exploits/#{id}"
          end

          # Return [] if a key cannot be found in json
          # OR if a value is not of an expected type
        rescue ex : KeyError | TypeCastError
          yield results
          return
        end

        # Finally return the results
        yield results
      end
    end
  end
end
